#!/usr/bin/env ruby

LKP_SRC = ENV['LKP_SRC'] || File.dirname(File.dirname(File.dirname(File.realpath($PROGRAM_NAME))))

require 'json'
require "#{LKP_SRC}/lib/log"

raw = STDIN.read.strip

# Split concatenated JSON objects
chunks = raw.split(/\}\s*\{/)

json_strings =
  if chunks.size == 1
    # Only one JSON object â†’ use directly
    [raw]
  else
    chunks.map.with_index do |chunk, idx|
      if idx == 0
        chunk + "}"
      elsif idx == chunks.size - 1
        "{" + chunk
      else
        "{" + chunk + "}"
      end
    end
  end

bps_values = []
bps_tcp_sender_values = []
bps_tcp_receiver_values = []
bps_udp_values = []

json_strings.each_with_index do |json_str, idx|
  begin
    obj = JSON.parse(json_str)

    bps_udp = obj.dig("end", "sum", "bits_per_second")

    if bps_udp.nil?
      bps_tcp_sender = obj.dig("end", "sum_sent", "bits_per_second")
      bps_tcp_receiver = obj.dig("end", "sum_received", "bits_per_second")
    end

    if (bps_tcp_sender.nil? && bps_tcp_receiver.nil? && bps_udp.nil?)
      log_error "warning: no bits_per_second in session #{idx+1}"
      next
    end

    bps_tcp_sender_values << bps_tcp_sender.to_f
    bps_tcp_receiver_values << bps_tcp_receiver.to_f
    bps_udp_values << bps_udp.to_f

  rescue JSON::ParserError => e
    log_error "error: malformed JSON in session #{idx+1}"
    log_error e.message[0..300]
    next
  end
end

if (bps_tcp_sender_values.empty? && bps_tcp_receiver_values.empty? && bps_udp_values.empty?)
  log_error "error: no valid iperf sessions parsed"
  exit 1
end

avg_bps_tcp_sender = bps_tcp_sender_values.sum / bps_tcp_sender_values.size
avg_bps_tcp_receiver = bps_tcp_receiver_values.sum / bps_tcp_receiver_values.size
avg_bps_udp = bps_udp_values.sum / bps_udp_values.size

puts "tcp.sender.bps: #{avg_bps_tcp_sender}" if avg_bps_tcp_sender
puts "tcp.receiver.bps: #{avg_bps_tcp_receiver}" if avg_bps_tcp_receiver
puts "udp.bps: #{avg_bps_udp}" if avg_bps_udp
